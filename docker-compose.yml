services:
  funasr:
    image: packeting/funasr:latest
    container_name: chat_funasr
    restart: unless-stopped
    privileged: true
    command: >
      /bin/bash -c "
      echo 'ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–...' &&
      apt-get update &&
      apt-get install -y ffmpeg git-lfs &&
      echo 'âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ' &&
      echo 'ğŸ”„ åˆå§‹åŒ–æ¨¡å‹ç›®å½•...' &&
      mkdir -p /workspace/models &&
      cd /workspace/models &&
      git lfs install &&
      echo 'âœ… Git LFS åˆå§‹åŒ–å®Œæˆ' &&
      echo 'ğŸ“¥ ä¸‹è½½è¯­éŸ³è¯†åˆ«æ¨¡å‹...' &&
      if [ ! -d 'speech_paraformer-large_asr_nat-zh-cantonese-en-16k-vocab8501-online' ]; then
        git clone https://huggingface.co/packetingz/speech_paraformer-large_asr_nat-zh-cantonese-en-16k-vocab8501-online;
        echo 'âœ… æ¨¡å‹ä¸‹è½½å®Œæˆ';
      else
        echo 'âš¡ æ¨¡å‹å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½';
      fi &&
      echo 'ğŸ”„ æ£€æŸ¥å’Œè½¬æ¢æ¨¡å‹æ ¼å¼...' &&
      cd /workspace/models &&
      if [ ! -f 'speech_paraformer-large_asr_nat-zh-cantonese-en-16k-vocab8501-online/model_quant.onnx' ] || [ ! -f 'speech_paraformer-large_asr_nat-zh-cantonese-en-16k-vocab8501-online/decoder_quant.onnx' ]; then
        echo 'ğŸ”§ è½¬æ¢PTæ¨¡å‹ä¸ºONNXæ¨¡å‹...' &&
        funasr-export ++model=speech_paraformer-large_asr_nat-zh-cantonese-en-16k-vocab8501-online ++Quantize=false &&
        echo 'âœ… æ¨¡å‹è½¬æ¢å®Œæˆ' &&
        echo 'ğŸ“ é‡å‘½åONNXæ–‡ä»¶...' &&
        cd speech_paraformer-large_asr_nat-zh-cantonese-en-16k-vocab8501-online &&
        if [ -f 'decoder.onnx' ]; then mv decoder.onnx decoder_quant.onnx; fi &&
        if [ -f 'model.onnx' ]; then mv model.onnx model_quant.onnx; fi &&
        echo 'âœ… æ¨¡å‹æ–‡ä»¶é‡å‘½åå®Œæˆ';
      else
        echo 'âš¡ ONNXæ¨¡å‹å·²å­˜åœ¨ï¼Œè·³è¿‡è½¬æ¢';
      fi &&
      echo 'ğŸ“‹ æ¨¡å‹ç›®å½•æ–‡ä»¶åˆ—è¡¨:' &&
      ls -la /workspace/models/speech_paraformer-large_asr_nat-zh-cantonese-en-16k-vocab8501-online/ &&
      echo 'âœ… æ¨¡å‹å‡†å¤‡å®Œæˆ' &&
      echo 'ğŸš€ å¯åŠ¨FunASRæœåŠ¡å™¨...' &&
      cd /workspace/FunASR/runtime &&
      bash run_server_2pass.sh &&
      tail -f /dev/null
      "
    volumes:
      - model_data:/workspace/models
    networks:
      - funasr_network

  redis:
    image: redis:7-alpine
    container_name: chat_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - funasr_network

  web:
    build: .
    container_name: chat_web
    restart: unless-stopped
    ports:
      - "8000:8000"
      - "32796:8443"
    volumes:
      - ./:/app
      - db_data:/app/data
    depends_on:
      - redis
      - funasr
    environment:
      - DJANGO_SETTINGS_MODULE=ai_chat_server.settings
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - FUNASR_HOST=funasr
      - DATABASE_PATH=/app/data/db.sqlite3
    networks:
      - funasr_network

volumes:
  redis_data:
  db_data:
  model_data:

networks:
  funasr_network:
    driver: bridge 